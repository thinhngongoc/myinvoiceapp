<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa đơn {{ invoice.mahd }} - In ấn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style id="print-style">
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 10pt;
            /* Giảm font chữ tổng thể xuống 10pt */
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            /* Dùng flexbox để đẩy footer xuống cuối */
            flex-direction: column;
            /* Sắp xếp các phần tử theo cột */
            min-height: 98vh;
            /* Đảm bảo body có chiều cao gần bằng trang in */
        }

        .container-print {
            max-width: 800px;
            margin: 10px auto;
            /* Giảm margin tổng thể */
            padding: 10px;
            /* Giảm padding tổng thể */
            border: 1px solid #ccc;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            /* Cho phép container-print mở rộng để đẩy footer */
            display: flex;
            /* Thêm flex để sắp xếp nội dung bên trong */
            flex-direction: column;
            /* Sắp xếp nội dung bên trong theo cột */
        }

        /* Điều chỉnh header */
        .header-section-new {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* Căn trên cùng */
            margin-bottom: 5px;
            /* Giảm margin */
            padding-bottom: 3px;
            /* Giảm padding */
            border-bottom: 1px dashed #ccc;
        }

        .header-left {
            text-align: left;
            flex-grow: 1;
            padding-right: 10px;
            /* Giảm khoảng cách */
        }

        .header-left h2 {
            font-size: 16pt;
            /* Giảm font chữ HÓA ĐƠN */
            margin-bottom: 2px;
            /* Giảm margin */
            text-transform: uppercase;
            font-weight: bold;
        }

        .header-left p {
            margin: 0;
            font-size: 8.5pt;
            /* Giảm font */
            line-height: 1.1;
            /* Giảm line-height */
        }

        .header-right-store-info {
            text-align: left;
            flex-shrink: 0;
            width: 280px;
            padding-left: 10px;
            /* Giảm khoảng cách */
            border-left: 1px dashed #eee;
        }

        .header-right-store-info h4 {
            font-size: 10pt;
            /* Giảm font */
            margin-bottom: 0;
            text-decoration: none;
            text-align: center;
            font-weight: bold;
        }

        .header-right-store-info p {
            margin-bottom: 1px;
            font-size: 8.5pt;
            /* Giảm font */
            line-height: 1.1;
            /* Giảm line-height */
        }

        .header-right-store-info strong {
            display: inline-block;
            width: 80px;
            /* Giảm chiều rộng label */
            text-align: left;
            font-weight: normal;
        }

        .header-right-store-info p span {
            font-weight: bold;
        }

        /* Điều chỉnh phần thông tin khách hàng và tổng tiền */
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            /* Giảm margin */
            border-bottom: 1px dashed #ccc;
            padding-bottom: 3px;
            /* Giảm padding */
        }

        .info-block {
            flex: 1;
            padding-right: 8px;
            /* Giảm padding */
        }

        .info-block:last-child {
            padding-right: 0;
            padding-left: 8px;
            /* Giảm padding */
            border-left: 1px dashed #eee;
        }

        .info-block h4 {
            font-size: 10pt;
            /* Giảm font */
            margin-bottom: 4px;
            /* Giảm margin */
            text-decoration: underline;
        }

        .info-block p {
            margin-bottom: 1px;
            /* Giảm margin cực nhỏ */
            font-size: 8.5pt;
            /* Giảm font */
            line-height: 1.1;
            /* Giảm line-height */
        }

        .info-block strong {
            display: inline-block;
            width: 80px;
            /* Giảm chiều rộng label */
            text-align: left;
            font-weight: normal;
        }

        .info-block p span {
            font-weight: bold;
        }

        /* Style cho khối tổng tiền */
        .totals-section-new {
            flex: 1;
            padding-left: 8px;
            /* Giảm padding */
            text-align: right;
        }

        .totals-section-new h4 {
            font-size: 10pt;
            /* Giảm font */
            margin-bottom: 4px;
            /* Giảm margin */
            text-decoration: underline;
            text-align: left;
        }

        .totals-section-new .total-sum-item {
            margin-bottom: 1px;
            /* Giảm margin cực nhỏ */
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-size: 9pt;
            /* Giảm font */
        }

        .totals-section-new .total-sum-item .label {
            flex-shrink: 0;
            width: 140px;
            /* Giảm chiều rộng label */
            text-align: left;
            font-weight: normal;
            padding-left: 4px;
            /* Giảm padding */
        }

        .totals-section-new .total-sum-item span:last-child {
            flex-grow: 1;
            text-align: right;
            width: auto;
            padding-right: 4px;
            /* Giảm padding */
            font-weight: bold;
        }

        .totals-section-new .con-no-value {
            font-size: 10pt;
            /* Giảm font */
            font-weight: bold;
            color: red;
        }

        .totals-section-new .con-no-value span:last-child {
            color: red;
        }

        .totals-section-new .con-no-text {
            font-style: italic;
            color: #555;
            margin-top: 2px;
            text-align: right;
            font-size: 8.5pt;
            /* Giảm font */
        }


        .invoice-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            /* Giảm margin */
            flex-grow: 1;
        }

        .invoice-details-table th,
        .invoice-details-table td {
            border: 1px solid #ccc;
            padding: 2px 4px;
            /* Giảm padding đáng kể hơn */
            text-align: left;
            font-size: 8.5pt;
            /* Giảm font chữ trong bảng */
            vertical-align: top;
            line-height: 1.1;
            /* Giảm line-height trong bảng */
        }

        .invoice-details-table th {
            background-color: #f2f2f2;
            text-align: center;
            font-weight: bold;
        }

        /* Chiều rộng cột được giữ nguyên như trước, vì đã khá tối ưu */
        .invoice-details-table td:nth-child(1) {
            width: 4%;
            text-align: center;
        }

        /* TT */
        .invoice-details-table td:nth-child(2) {
            width: auto;
        }

        /* Sản phẩm */
        .invoice-details-table td:nth-child(3) {
            width: 6%;
            text-align: center;
        }

        /* ĐVT */
        .invoice-details-table td:nth-child(4) {
            width: 8%;
            text-align: right;
        }

        /* SL */
        .invoice-details-table td:nth-child(5) {
            width: 12%;
            text-align: right;
        }

        /* Đơn giá */
        .invoice-details-table td:nth-child(6) {
            width: 6%;
            text-align: center;
        }

        /* CK (%) */
        .invoice-details-table td:nth-child(7) {
            width: 15%;
            text-align: right;
        }

        /* Thành tiền */

        .totals-section {
            display: none;
        }

        .footer-invoice {
            margin-top: 20px;
            /* Giảm margin */
            text-align: center;
            display: flex;
            justify-content: space-around;
            font-weight: bold;
            font-size: 8.5pt;
            /* Giảm font */
        }

        .signature-block {
            flex: 1;
            text-align: center;
        }

        .signature-title {
            margin-bottom: 40px;
            /* Giảm khoảng trống cho chữ ký */
        }

        .note-text {
            text-align: center;
            margin-top: auto;
            margin-bottom: 0;
            padding-top: 10px;
            /* Giảm padding */
            font-style: italic;
            font-size: 7.5pt;
            /* Giảm font chữ nhỏ nhất */
            color: #777;
        }

        /* Ẩn các nút điều khiển và modal (nếu có) khi in */
        @media print {

            .print-controls,
            .custom-modal {
                display: none;
            }

            @page {
                size: A4 portrait;
                margin: 6mm 8mm 6mm 8mm;
                /* Giảm margin tổng thể cho in ấn */
            }

            body {
                margin: 0;
                padding: 0;
                min-height: auto;
            }

            .container-print {
                border: none;
                box-shadow: none;
                margin: 0;
                padding: 0mm;
                max-width: none;
                flex-grow: 0;
            }

            .info-section,
            .header-section-new {
                border-bottom: none !important;
                border-top: none !important;
            }

            .info-block:last-child,
            .header-right-store-info {
                border-left: none !important;
            }

            .note-text {
                position: fixed;
                bottom: 6mm;
                /* Cách lề dưới của trang in 6mm */
                left: 0;
                right: 0;
                width: 100%;
                text-align: center;
                margin: 0;
                padding: 0;
                font-size: 7.5pt;
                color: #777;
            }
        }
    </style>
</head>

<body>
    <div class="container-print">
        <div class="header-section-new">
            <div class="header-left">
                <h2>HÓA ĐƠN</h2>
                <p>Mã hóa đơn: <strong>{{ invoice.mahd }}</strong></p>
                <p>Ngày lập: <strong>{{ invoice.ngaylap_formatted }}</strong></p>
            </div>
            <div class="header-right-store-info">
                <p><strong>Tên Cửa hàng:</strong> <span>Cửa hàng Ngọc Huệ</span></p>
                <p><strong>Địa chỉ:</strong> <span>Chân cầu vượt An Khánh, Phú Vinh, An Khánh, Hà Nội</span></p>
                <p><strong>Điện thoại:</strong> <span>0936266648-0936068911</span></p>
                <p><strong>MST:</strong> <span>xxx</span></p>
            </div>
        </div>

        <hr>

        <div class="info-section">
            <div class="info-block">
                <h4>Thông tin khách hàng:</h4>
                <p><strong>Tên KH:</strong> <span>{{ invoice.customer.tenkh or 'N/A' }}</span></p>
                <p><strong>Địa chỉ/SĐT:</strong> <span>{{ invoice.customer.diachi_sdt or 'N/A' }}</span></p>
                <p>
                    <strong>Dư nợ:</strong>
                    <span>
                        {{ "{:,.0f} đ".format(invoice.customer.conno | default(0)) }}
                        <span id="total_customer_debt_text"
                            style="font-style: italic; font-size: 0.9em; color: #555;"></span>
                    </span>
                </p>
            </div>
            <div class="info-block totals-section-new">
                <h4>Tổng tiền hóa đơn:</h4>
                <div class="total-sum-item">
                    <span class="label">Tổng tiền hàng:</span>
                    <span>{{ "{:,.0f} đ".format(invoice.congtienhang) }}</span>
                </div>
                <div class="total-sum-item">
                    <span class="label">Tổng chiết khấu:</span>
                    <span>{{ "{:,.0f} đ".format(invoice.congchietkhau) }}</span>
                </div>
                <div class="total-sum-item">
                    <span class="label">Khách đã thanh toán:</span>
                    <span>{{ "{:,.0f} đ".format(invoice.khhdathanhtoan) }}</span>
                </div>

                <div class="total-sum-item con-no-value">
                    <span class="label">Chưa thanh toán:</span>
                    <span>{{ "{:,.0f} đ".format(invoice.conno) }}</span>
                </div>

                <div class="con-no-text">
                    <span id="conno_text" style="font-weight: bold;"></span>
                </div>
            </div>
        </div>

        <hr>

        <h4>Chi tiết sản phẩm:</h4>
        <table class="invoice-details-table">
            <thead>
                <tr>
                    <th>TT</th>
                    <th>Sản phẩm</th>
                    <th>ĐVT</th>
                    <th>SL</th>
                    <th>Đơn giá</th>
                    <th>CK (%)</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                {% for detail in invoice.details %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ detail.product.tensp or 'Sản phẩm không xác định' }}</td>
                    <td>{{ detail.donvi or 'N/A' }}</td>
                    <td>{{ "{:,.0f}".format(detail.sl) }}</td>
                    <td>{{ "{:,.0f}".format(detail.dongia) }}</td>
                    <td>{{ "{:,.0f}".format(detail.ck) }}</td>
                    <td>{{ "{:,.0f}".format(detail.thanhtien) }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center;">Không có chi tiết sản phẩm.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="totals-section"></div>

        <div class="footer-invoice">
            <div class="signature-block">
                <p class="signature-title">Người lập phiếu</p>
                <p>(Ký, ghi rõ họ tên)</p>
            </div>
            <div class="signature-block">
                <p class="signature-title">Khách hàng</p>
                <p>(Ký, ghi rõ họ tên)</p>
            </div>
        </div>

        <div class="container-print">
        <script>
            // === HÀM CHUYỂN ĐỔI SỐ THÀNH CHỮ TIẾNG VIỆT ===
            function convertNumberToVietnameseText(number) {
                const roundedNumber = Math.round(number * 100) / 100;
                let absNumber = Math.abs(roundedNumber);

                if (absNumber === 0) return "Không đồng";

                const units = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
                const teens = ["mười", "mười một", "mười hai", "mười ba", "mười bốn", "mười lăm", "mười sáu", "mười bảy", "mười tám", "mười chín"];
                const tens = ["", "mười", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
                const levels = ["", "nghìn", "triệu", "tỷ", "nghìn tỷ", "triệu tỷ", "tỷ tỷ"];

                function readUnderThousand(num) {
                    let str = "";
                    const h = Math.floor(num / 100);
                    const t = Math.floor((num % 100) / 10);
                    const u = num % 10;

                    if (h > 0) {
                        str += units[h] + " trăm ";
                    }

                    if (t === 0 && u === 0) {
                        // Nothing
                    } else if (t === 0) {
                        str += (h > 0 ? "linh " : "") + units[u];
                    } else if (t === 1) {
                        str += teens[u];
                    } else {
                        str += tens[t] + " ";
                        if (u === 1) str += "mốt";
                        else if (u === 5) str += "lăm";
                        else if (u > 0) str += units[u];
                    }
                    return str.trim();
                }

                let result = "";
                let integerPart = Math.floor(absNumber);
                let decimalPart = Math.round((absNumber - integerPart) * 100);

                if (integerPart === 0 && decimalPart === 0) {
                    return "Không đồng";
                }

                let i = 0;
                while (integerPart > 0) {
                    const threeDigits = integerPart % 1000;
                    if (threeDigits !== 0) {
                        let chunk = readUnderThousand(threeDigits) + " " + levels[i];
                        result = chunk.trim() + " " + result;
                    }
                    integerPart = Math.floor(integerPart / 1000);
                    i++;
                }

                result = result.trim();

                if (decimalPart > 0) {
                    let decimalText = readUnderThousand(decimalPart);
                    result += (result ? " phẩy " : "") + decimalText + " xu";
                } else {
                    result += " đồng";
                }

                if (roundedNumber < 0) {
                    result = "âm " + result;
                }

                result = result.charAt(0).toUpperCase() + result.slice(1);
                return result;
            }
            // === END OF convertNumberToVietnameseText FUNCTION ===

            // Hàm để cập nhật CSS @page
            function setPrintPaperSizeAndOrientation(size, orientation = 'portrait') {
                const styleTag = document.getElementById('print-style');
                if (!styleTag) {
                    console.error("Style tag with ID 'print-style' not found.");
                    return;
                }

                let currentCss = styleTag.innerHTML;

                // Xóa bỏ quy tắc @media print chứa @page cũ nếu có
                currentCss = currentCss.replace(/(@media\s*print\s*{[\s\S]*?@page\s*{[\s\S]*?}[\s\S]*?})/s, '');

                // Thêm quy tắc @page mới với khổ và hướng đã chọn
                const newPageRule = `
                @media print {
                    @page {
                        size: ${size} ${orientation};
                        margin: 6mm 8mm 6mm 8mm; /* Đã điều chỉnh margin */
                    }
                    body {
                        margin: 0;
                        padding: 0;
                        min-height: auto;
                    }
                    .container-print {
                        border: none;
                        box-shadow: none;
                        margin: 0;
                        padding: 0mm;
                        max-width: none;
                        flex-grow: 0;
                    }
                    .info-section, .header-section-new {
                        border-bottom: none !important;
                        border-top: none !important;
                    }
                    .info-block:last-child, .header-right-store-info {
                        border-left: none !important;
                    }
                    .note-text {
                        position: fixed;
                        bottom: 6mm; /* Đã điều chỉnh bottom */
                        left: 0;
                        right: 0;
                        width: 100%;
                        text-align: center;
                        margin: 0;
                        padding: 0;
                        font-size: 7.5pt;
                        color: #777;
                    }
                }
            `;
                styleTag.innerHTML = currentCss + newPageRule;
                console.log(`Đã đặt khổ giấy in thành: ${size} ${orientation}`);
            }

            window.onload = function () {
                // Khởi tạo các giá trị công nợ và văn bản
                const invoiceConno = JSON.parse('{{ invoice.conno | default(0) | tojson }}');
                let invoiceConnoText = "";
                if (invoiceConno < 0) {
                    invoiceConnoText = "Khách hàng trả thừa " + convertNumberToVietnameseText(Math.abs(invoiceConno)).toLowerCase();
                } else if (invoiceConno > 0) {
                    invoiceConnoText = convertNumberToVietnameseText(invoiceConno);
                } else {
                    invoiceConnoText = "Không đồng";
                }
                document.getElementById('conno_text').innerText = invoiceConnoText;

                const totalCustomerConno = JSON.parse('{{ invoice.customer.conno | default(0) | tojson }}');
                let totalCustomerConnoText = "";
                if (totalCustomerConno < 0) {
                    totalCustomerConnoText = "(Trả thừa " + convertNumberToVietnameseText(Math.abs(totalCustomerConno)).toLowerCase() + ")";
                } else if (totalCustomerConno > 0) {
                    totalCustomerConnoText = "(" + convertNumberToVietnameseText(totalCustomerConno).toLowerCase() + ")";
                } else {
                    totalCustomerConnoText = "(Không đồng)";
                }
                document.getElementById('total_customer_debt_text').innerText = totalCustomerConnoText;

                setPrintPaperSizeAndOrientation('A4', 'portrait');
                window.print();
            };
        </script>
</body>

</html>